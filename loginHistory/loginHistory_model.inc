<?php
/**
 * =====================================================================================
	プログラム名  ：	勤怠管理システム（Web版）
 	プログラム説明：社員の勤怠情報を管理するシステムです。
 				管理者はカレンダーを使用して視覚的に勤怠の登録、削除、変更
 				を行えるほか各社員の勤怠情報の閲覧、休日、休憩時間の設定
 				機能を使用することができます。

 				勤怠情報とカレンダー部分はPDF,EXCEL出力することが可能です。
 	作成者        ：	水島創太
 	作成日        ：	2015/8/27
	=====================================================================================
 */

class loginHistory_model{

	//-----------------------------------------
	//各プロパティ変数宣言
	//-----------------------------------------

	private $loginDataList;		//ログイン履歴
	private $lastLoginData;		//最後にログインした日時情報

	/*====================================================================================
	 *概要：
	 *	updateUser_form
	 *機能説明：
	 *	コンストラクタ
	 *引数：
	 *	なし
	 *戻り値：
	 *	なし
	 *備考：
	 *	作成日)	2015/8/27
	 *	作成者)	水島創太
	 *	説明）
	 *	更新日)
	 *	更新者)
	 *	変更)
	  ====================================================================================
	 */

	function __construct(){

		$this->init();

	}

	/*====================================================================================
	 *概要：
	 *	init
	 *機能説明：
	 *	プロパティ初期化
	 *引数：
	 *	なし
	 *戻り値：
	 *	なし
	 *備考：
	 *	作成日)	2015/8/27
	 *	作成者)	水島創太
	 *	説明）
	 *	更新日)	2015/10/30
	 *	更新者)	鈴木一紘
	 *	変更)	ログイン履歴用に変更
	  ====================================================================================
	 */

 	private function init(){

	$this->loginDataList = array();			//
	$this->lastLoginData = array();			//

	}

	/*====================================================================================
	 *概要：
	 *	setter関数
	 *機能説明：
	 *	値をフィールド変数に格納
	 *引数：
	 *	各種格納する値
	 *戻り値：
	 *	なし
	 *備考：
	 *	作成日)	2015/8/27
	 *	作成者)	水島創太
	 *	説明）
	 *	更新日)	2015/10/30
	 *	更新者)	鈴木一紘
	 *	変更)	ログイン履歴用に変更
	  ====================================================================================
	 */

		//入力ユーザーID
		public function setLoginDataList($param)
		{
			$this->loginDataList = $param;
		}

		//最後にログインした日時情報
		public function setLastLoginData($param)
		{
			$this->lastLoginData = $param;
		}

	/*====================================================================================
	 *概要：
	 *	getter関数
	 *機能説明：
	 *	値をフィールド変数から取得
	 *引数：
	 *	なし
	 *戻り値：
	 *	各種格納した値
	 *備考：
	 *	作成日)	2015/7/28
	 *	作成者)	水島創太
	 *	説明）
	 *	更新日)	2015/10/30
	 *	更新者)	鈴木一紘
	 *	変更)	ログイン履歴用に変更
	  ====================================================================================
	 */

		//ログイン履歴
		public function getLoginDataList()
		{
			return $this->loginDataList;
		}

		//最後にログインした日時情報
		public function getLastLoginData()
		{
			return $this->lastLoginData;
		}

	/*====================================================================================
	 *概要：
	 *	processing
	 *機能説明：
	 *	全体の処理判定を行う
	 *引数：
	 *	なし
	 *戻り値：
	 *	なし
	 *備考：
	 *	作成日)	2015/10/30
	 *	作成者)	鈴木一紘
	 *	説明）
	 *	更新日)
	 *	更新者)
	 *	変更)
	  ====================================================================================
	 */

		public function processing($db)
		{
			//ログイン履歴の配列をDBから受け取り格納する
			$this->loginDataList = $this->searchLoginData($db);

			//最後にログインした日時情報をDBから受け取り格納する
			$this->lastLoginData = $this->searchLastData($db);
		}

	/*====================================================================================
	 *概要：
	 *	searchLoginData()
	 *機能説明：
	 *	各ユーザーのログイン履歴を取得する。
	 *引数：
	 *	データベース情報
	 *戻り値：
	 *	各ユーザーのログイン履歴情報
	 *備考：
	 *	作成日)	2015/10/30
	 *	作成者)	鈴木一紘
	 *	説明）
	 *	更新日)
	 *	更新者)
	 *	変更)
	  ====================================================================================
	 */

		private function searchLoginData($db){

			//MySQL文の用意
			$sql = "SELECT A.name, L.record, L.host, L.browser, L.count, C.code
					FROM logininfo L
					INNER JOIN accountinfo A ON L.accountid = A.accountid
					INNER JOIN colorinfo C ON A.colorid = C.colorid
					ORDER BY record DESC
					LIMIT 20";

			//SQL文の発行
			$result = mysql_query($sql,$db);

			//検索結果の件数を取得
			$rows = mysql_num_rows($result);

			//検索結果があるかどうかをチェック
			if($rows > 0){

				//繰り返し処理を使用して全取得データを$tfに格納
				while($row = mysql_fetch_assoc($result))｛
					$tf[] = $row;
				｝

			}else{
				$tf = false;
			}

			//検索結果の開放
			mysql_free_result($result);

			//結果を返す
			return $tf;
		}


	/*====================================================================================
	 *概要：
	 *	searchLastData()
	 *機能説明：
	 *	各ユーザーの最後にログインした日時の情報を取得する。
	 *引数：
	 *	データベース情報
	 *戻り値：
	 *	各ユーザーの最後にログインした日時情報
	 *備考：
	 *	作成日)	2015/10/30
	 *	作成者)	鈴木一紘
	 *	説明）
	 *	更新日)
	 *	更新者)
	 *	変更)
	  ====================================================================================
	 */

		private function searchLastData($db){

			//MySQL文の用意
			$sql = "SELECT A.name, MAX(L.record) AS lastrecord, MAX(L.count) AS count,
						   L.host, L.browser, C.code
					FROM logininfo L
					INNER JOIN accountinfo A ON A.accountid = L.accountid
					INNER JOIN colorinfo C ON A.colorid = C.colorid
					GROUP BY L.accountid";

			//SQL文の発行
			$result = mysql_query($sql,$db);

			//検索結果の件数を取得
			$rows = mysql_num_rows($result);

			//検索結果があるかどうかをチェック
			if($rows > 0){

				//繰り返し処理を使用して全取得データを$tfに格納
				while($row = mysql_fetch_assoc($result)){
					$tf[] = $row;
				}

			}else{
				$tf = false;
			}

			//検索結果の開放
			mysql_free_result($result);

			//結果を返す
			return $tf;
		}
}
?>